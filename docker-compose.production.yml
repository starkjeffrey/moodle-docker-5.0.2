version: '3.8'

services:
  # Traefik Reverse Proxy for automatic SSL
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=it@pucsr.edu.kh"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # Redirect HTTP to HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/letsencrypt:/letsencrypt
      - ./traefik/config:/config
    networks:
      - moodle-network
    labels:
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.dashboard.rule=Host(`traefik.pucsr.edu.kh`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$2y$$10$$yourhashedpasswordhere"

  # MariaDB Database
  mariadb:
    image: mariadb:11.4
    container_name: moodle-mariadb
    restart: unless-stopped
    env_file:
      - .envs/.mariadb/mariadb.env
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./backup-system/temp:/backup
    networks:
      - moodle-network
    healthcheck:
      test: ['CMD', 'healthcheck.sh', '--connect', '--innodb_initialized']
      interval: 15s
      timeout: 5s
      retries: 6
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # Redis Cache
  redis:
    image: redis:7.2-alpine
    container_name: moodle-redis
    restart: unless-stopped
    command: redis-server --requirepass redis_secure_password --maxclients 10000
    volumes:
      - redis_data:/data
    networks:
      - moodle-network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Moodle Application
  moodle:
    image: bitnami/moodle:5.0.2
    container_name: moodle-app
    restart: unless-stopped
    env_file:
      - .envs/.moodle/moodle-production.env
    volumes:
      - moodle_data:/bitnami/moodle
      - moodledata_data:/bitnami/moodledata
      # Mount custom theme if available
      # - ./.envs/theme/pucsr-boost:/bitnami/moodle/theme/pucsr-boost
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - moodle-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.moodle.rule=Host(`moodle.pucsr.edu.kh`)"
      - "traefik.http.routers.moodle.entrypoints=websecure"
      - "traefik.http.routers.moodle.tls.certresolver=letsencrypt"
      - "traefik.http.services.moodle.loadbalancer.server.port=8080"
      # Security headers
      - "traefik.http.middlewares.moodle-headers.headers.customresponseheaders.X-Frame-Options=SAMEORIGIN"
      - "traefik.http.middlewares.moodle-headers.headers.customresponseheaders.X-Content-Type-Options=nosniff"
      - "traefik.http.middlewares.moodle-headers.headers.customresponseheaders.X-XSS-Protection=1; mode=block"
      - "traefik.http.routers.moodle.middlewares=moodle-headers"
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 2G
          cpus: '1'

  # Backup Service (runs periodically)
  backup:
    build:
      context: ./backup-system
      dockerfile: Dockerfile.backup
    container_name: moodle-backup
    restart: unless-stopped
    env_file:
      - ./backup-system/configs/backup.conf
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./backup-system:/backup-system
      - /backup/moodle:/backup/moodle
      - moodle_data:/data/moodle:ro
      - moodledata_data:/data/moodledata:ro
      - mariadb_data:/data/mariadb:ro
      - redis_data:/data/redis:ro
    networks:
      - moodle-network
    depends_on:
      - moodle
      - mariadb
      - redis

volumes:
  mariadb_data:
    driver: local
  moodle_data:
    driver: local
  moodledata_data:
    driver: local
  redis_data:
    driver: local

networks:
  moodle-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/24