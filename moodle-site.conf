server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    root /var/www/html;
    index index.php index.html;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Moodle specific locations
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP processing
    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;

        # Security: Ensure the PHP file exists before passing it to PHP-FPM
        if (!-f $document_root$fastcgi_script_name) {
            return 404;
        }

        fastcgi_pass php-fpm;
        fastcgi_index index.php;

        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;

        # Performance optimizations
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        fastcgi_read_timeout 300;

        # Cache configuration for non-logged in users
        set $skip_cache 0;

        # POST requests and URLs with query strings should always skip cache
        if ($request_method = POST) {
            set $skip_cache 1;
        }
        if ($query_string != "") {
            set $skip_cache 1;
        }

        # Don't cache logged in users
        if ($http_cookie ~* "MoodleSession") {
            set $skip_cache 1;
        }

        # Enable cache for specific pages
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache MOODLE;
        fastcgi_cache_valid 200 60m;
        fastcgi_cache_valid 404 10m;
        fastcgi_cache_methods GET HEAD;

        # Add cache status header
        add_header X-Cache-Status $upstream_cache_status;
    }

    # Static file handling with caching
    location ~* \.(jpg|jpeg|gif|png|webp|svg|woff|woff2|ttf|css|js|ico|xml|pdf|flv|swf|mp3|mp4|wav|ogg|webm)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Moodle dataroot protection
    location /moodledata/ {
        internal;
    }

    # Protect Moodle files
    location ~ (/vendor/|/node_modules/|composer\.(json|lock)|package\.(json|lock)) {
        deny all;
        return 404;
    }

    # Rate limiting for login page
    location = /login/index.php {
        limit_req zone=login burst=5 nodelay;
        try_files $uri /index.php?$query_string;
    }

    # Apply general rate limiting
    limit_req zone=general burst=20 nodelay;
}