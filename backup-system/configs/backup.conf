#!/bin/bash

# Comprehensive Backup Configuration
# System: Moodle Docker with Naga SIS Integration

# ============================================
# BASIC CONFIGURATION
# ============================================

# Project paths
MOODLE_PROJECT_DIR="/Volumes/Projects/active/moodle-docker-5.0.2"
BACKUP_ROOT="/backup/moodle"
BACKUP_STAGING="/backup/staging"

# Database credentials (update these with your actual credentials)
DB_USER="bn_moodle"
DB_PASSWORD="bitnami123"
DB_NAME="bitnami_moodle"

# Redis credentials (for hardened setup)
REDIS_PASSWORD="redis_password_change_me"

# Moodle API Configuration (for Naga SIS integration)
MOODLE_API_URL="http://localhost/webservice/rest/server.php"
MOODLE_API_TOKEN="your_moodle_api_token_here"
NAGA_SIS_API_URL="http://naga-sis.local/api"
NAGA_SIS_API_TOKEN="your_naga_sis_token_here"

# ============================================
# BACKUP SCHEDULE
# ============================================

# Backup types and schedules
ENABLE_DAILY_BACKUP="true"
ENABLE_WEEKLY_BACKUP="true"
ENABLE_MONTHLY_BACKUP="true"
ENABLE_INCREMENTAL_BACKUP="true"

# Schedule times (24-hour format)
DAILY_BACKUP_TIME="02:00"
WEEKLY_BACKUP_DAY="0"  # Sunday
WEEKLY_BACKUP_TIME="03:00"
MONTHLY_BACKUP_DAY="1"  # First day of month
MONTHLY_BACKUP_TIME="04:00"

# ============================================
# RETENTION POLICY
# ============================================

DAILY_RETENTION_DAYS=7
WEEKLY_RETENTION_WEEKS=4
MONTHLY_RETENTION_MONTHS=12
YEARLY_RETENTION_YEARS=5

# Maximum number of backups to keep
MAX_LOCAL_BACKUPS=50
MAX_REMOTE_BACKUPS=100

# ============================================
# STORAGE CONFIGURATION
# ============================================

# Local storage
MIN_DISK_SPACE_GB=10
COMPRESSION_LEVEL=9  # 1-9, higher = better compression

# Encryption
ENABLE_ENCRYPTION="true"
ENCRYPTION_PASSWORD="your_strong_encryption_password_here"
ENCRYPTION_ALGORITHM="aes-256-cbc"

# ============================================
# REMOTE STORAGE - AWS S3
# ============================================

ENABLE_S3_BACKUP="true"
AWS_PROFILE="default"
S3_BUCKET="your-moodle-backups"
S3_REGION="us-east-1"
S3_PREFIX="moodle-docker"
S3_STORAGE_CLASS="STANDARD_IA"  # STANDARD, STANDARD_IA, GLACIER, DEEP_ARCHIVE

# S3 Lifecycle rules
S3_TRANSITION_TO_GLACIER_DAYS=30
S3_TRANSITION_TO_DEEP_ARCHIVE_DAYS=90
S3_DELETE_AFTER_DAYS=365

# ============================================
# REMOTE STORAGE - GOOGLE DRIVE
# ============================================

ENABLE_GDRIVE_BACKUP="true"
GDRIVE_FOLDER_ID="your_google_drive_folder_id"
GDRIVE_SERVICE_ACCOUNT_FILE="/etc/backup/gdrive-service-account.json"
GDRIVE_MAX_FILE_SIZE_GB=15  # Google Drive has 15GB limit for single files

# Alternative: Backblaze B2 (more cost-effective than Google Drive for backups)
ENABLE_B2_BACKUP="false"
B2_ACCOUNT_ID="your_b2_account_id"
B2_APPLICATION_KEY="your_b2_app_key"
B2_BUCKET_NAME="your-moodle-backups"
B2_BUCKET_ID="your_bucket_id"

# ============================================
# REMOTE STORAGE - RSYNC/SSH
# ============================================

ENABLE_RSYNC_BACKUP="false"
RSYNC_HOST="backup.example.com"
RSYNC_USER="backup"
RSYNC_PATH="/backup/moodle"
RSYNC_SSH_KEY="/home/user/.ssh/backup_rsa"
RSYNC_PORT=22

# ============================================
# VERIFICATION SETTINGS
# ============================================

# Automatic verification
ENABLE_AUTO_VERIFY="true"
VERIFY_IMMEDIATELY="true"  # Verify right after backup
VERIFY_SCHEDULE="0 12 * * *"  # Also verify daily at noon
VERIFY_SAMPLE_SIZE=100  # Percentage of files to verify (100 = all)

# Restore testing
TEST_RESTORE="true"
TEST_RESTORE_FREQUENCY="weekly"  # daily, weekly, monthly
TEST_RESTORE_CONTAINER="moodle-test-restore"

# Data integrity checks
ENABLE_CHECKSUM_VERIFICATION="true"
CHECKSUM_ALGORITHM="sha256"
ENABLE_PAR2_RECOVERY="true"  # Create parity files for recovery

# ============================================
# MONITORING & ALERTING
# ============================================

# Email notifications
ENABLE_EMAIL_NOTIFICATIONS="true"
ADMIN_EMAIL="admin@example.com"
SMTP_HOST="smtp.gmail.com"
SMTP_PORT="587"
SMTP_USER="your-email@gmail.com"
SMTP_PASSWORD="your-app-password"
SMTP_USE_TLS="true"

# Slack notifications
ENABLE_SLACK_NOTIFICATIONS="true"
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
SLACK_CHANNEL="#backups"
SLACK_USERNAME="Backup Bot"

# Monitoring
ENABLE_MONITORING="true"
MONITORING_ENDPOINT="http://monitoring.example.com/webhook"
HEALTHCHECK_URL="https://hc-ping.com/your-uuid-here"

# Alert thresholds
ALERT_ON_FAILURE="true"
ALERT_ON_LOW_SPACE="true"
ALERT_LOW_SPACE_THRESHOLD_GB=5
ALERT_ON_LONG_BACKUP="true"
ALERT_LONG_BACKUP_THRESHOLD_MINUTES=60

# ============================================
# PERFORMANCE TUNING
# ============================================

# Parallel processing
ENABLE_PARALLEL_PROCESSING="true"
MAX_PARALLEL_JOBS=4

# Resource limits
MAX_CPU_PERCENT=80
MAX_MEMORY_MB=4096
NICE_LEVEL=10  # Lower priority for backup processes

# Network throttling (KB/s, 0 = unlimited)
UPLOAD_BANDWIDTH_LIMIT=0
DOWNLOAD_BANDWIDTH_LIMIT=0

# ============================================
# ADVANCED FEATURES
# ============================================

# Database-specific settings
ENABLE_BINARY_LOGS_BACKUP="true"
ENABLE_POINT_IN_TIME_RECOVERY="true"
BINLOG_RETENTION_DAYS=7

# Moodle-specific backups
BACKUP_MOODLE_DATA="true"
BACKUP_MOODLE_FILEDIR="true"
BACKUP_MOODLE_SESSIONS="true"
BACKUP_MOODLE_CACHE="false"  # Usually not needed
BACKUP_MOODLE_TEMP="false"   # Definitely not needed

# Naga SIS specific
BACKUP_NAGA_SIS_DATA="true"
NAGA_SIS_DB_NAME="naga_sis"
NAGA_SIS_DB_USER="naga_user"
NAGA_SIS_DB_PASSWORD="naga_password"

# API data export
EXPORT_MOODLE_COURSES="true"
EXPORT_MOODLE_USERS="true"
EXPORT_NAGA_SIS_STUDENTS="true"
EXPORT_NAGA_SIS_GRADES="true"

# Disaster recovery
ENABLE_DISASTER_RECOVERY_MODE="true"
DR_SITE_URL="https://dr.example.com"
DR_SYNC_INTERVAL_MINUTES=15

# Backup splitting for large datasets
ENABLE_SPLIT_BACKUPS="true"
SPLIT_SIZE_GB=5  # Split backups larger than this

# Deduplication
ENABLE_DEDUPLICATION="true"
DEDUP_TOOL="restic"  # or "borg"

# ============================================
# LOGGING
# ============================================

LOG_LEVEL="INFO"  # DEBUG, INFO, WARNING, ERROR
LOG_RETENTION_DAYS=90
ENABLE_AUDIT_LOG="true"
AUDIT_LOG_FILE="/var/log/backup-audit.log"